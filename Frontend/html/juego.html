<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magnar WarGames - Juego</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="../css/stylejuego.css">
</head>
<body>
    <!-- BARRA SUPERIOR (Sin cambios) -->
    <div id="top-bar">
        <div id="logo-casa-container">
             <img id="logo-casa" src="" alt="Logo de casa">
        </div>
        <div id="tropas-jugador" style="display: none;">
            <img src="../imgs/Interfaz/tropas.png" alt="Tropas">
            <span id="cantidad-tropas">0</span>
        </div>
        <div id="oro-jugador" style="display: none;">
            <img src="../imgs/Interfaz/oro.png" alt="Oro">
            <span id="cantidad-oro">0</span>
        </div>
    </div>

    <!-- Info Turno/Acci√≥n (Sin cambios) -->
    <div id="turno-jugador" class="turno-texto">Turno 1</div>
    <div id="accion-jugador" class="accion-texto">Acci√≥n 1</div>
    <div id="estado-turno"></div>

    <!-- CONTENEDOR BOTONES ACCI√ìN (Sin cambios estructurales) -->
    <div id="acciones-container">
        <button id="btn-batalla" class="btn-accion-juego">‚öîÔ∏è Batalla</button>
        <button id="btn-reclutar" class="btn-accion-juego">‚ûï Reclutar</button>
        <button id="btn-construir" class="btn-accion-juego">üî® Construir</button>
        <button id="btn-mover" class="btn-accion-juego">‚û°Ô∏è Mover/Atacar</button> <!-- Texto actualizado -->
        <button id="btn-reorganizar" class="btn-accion-juego">üîÑ Reorganizar</button>
        <!-- Podr√≠amos a√±adir botones para habilidades espec√≠ficas aqu√≠ -->
    </div>

    <!-- Bot√≥n Principal "Siguiente Acci√≥n" -->
    <button id="boton-accion" style="display: none;">
        ‚úÖ Terminar Acci√≥n
    </button>

    <!-- Modal Batalla (Sin cambios estructurales) -->
    <div id="modal-batalla" class="modal-juego" style="display: none;">
        <button id="btn-cerrar-modal-batalla" class="modal-cerrar">X</button>
        <h2>Resultado de Batalla</h2>
        <div class="campo-formulario">
            <label for="select-territorio-atacado">Territorio Atacado:</label>
            <select id="select-territorio-atacado"><option value="">-- Selecciona --</option></select>
        </div>
        <div class="campo-formulario">
            <fieldset><legend>Resultado:</legend>
                <label><input type="radio" name="resultado-batalla" value="victoria" checked> Victoria</label>
                <label><input type="radio" name="resultado-batalla" value="derrota"> Derrota</label>
            </fieldset>
        </div>
        <div class="campo-formulario campo-perdidas">
            <label for="input-perdidas-atacante">Mis P√©rdidas:</label>
            <div class="control-numero">
                <button id="btn-restar-perdidas-atacante">-</button>
                <input type="number" id="input-perdidas-atacante" value="0" min="0">
                <button id="btn-sumar-perdidas-atacante">+</button>
            </div>
        </div>
        <div class="campo-formulario campo-perdidas">
            <label for="input-perdidas-defensor">P√©rdidas Defensor:</label>
            <div class="control-numero">
                <button id="btn-restar-perdidas-defensor">-</button>
                <input type="number" id="input-perdidas-defensor" value="0" min="0">
                <button id="btn-sumar-perdidas-defensor">+</button>
            </div>
        </div>
        <div class="botones-modal">
             <button id="btn-confirmar-batalla" class="btn-confirmar">‚úîÔ∏è Confirmar</button>
             <button id="btn-cancelar-batalla" class="btn-cancelar">‚úñÔ∏è Cancelar</button>
        </div>
    </div>
    <!-- Fin Modal Batalla -->

    <!-- Modal Reclutar (Sin cambios estructurales) -->
    <div id="modal-reclutar" class="modal-juego" style="display: none;">
        <button class="modal-cerrar" onclick="cerrarModal('modal-reclutar')">X</button>
        <h2>Reclutar Unidades</h2>
        <div class="campo-formulario">
            <label for="select-territorio-reclutar">Reclutar en:</label>
            <select id="select-territorio-reclutar"><option value="">-- Selecciona territorio --</option></select>
        </div>
        <div class="campo-formulario">
            <label for="select-unidad-reclutar">Tipo de Unidad:</label>
            <select id="select-unidad-reclutar">
                <option value="regulares">Tropa Regular</option>
                <option value="mercenario">Mercenario</option>
                <option value="barco">Barco</option>
                <option value="torreAsedio">Torre de Asedio</option>
                <option value="catapulta">Catapulta</option>
                <option value="escorpion">Escorpi√≥n</option>
            </select>
        </div>
        <div class="campo-formulario">
            <label for="input-cantidad-reclutar">Cantidad:</label>
            <div class="control-numero">
                <button onclick="ajustarCantidadReclutar(-1)">-</button>
                <input type="number" id="input-cantidad-reclutar" value="1" min="1">
                <button onclick="ajustarCantidadReclutar(1)">+</button>
            </div>
        </div>
        <div id="costo-reclutamiento" style="text-align: center; margin-top: 15px; font-weight: bold;">
            Costo: <span id="costo-reclutar-valor">--</span> <img src="../imgs/Interfaz/oro.png" alt="oro" class="icono-inline">
        </div>
        <div id="limite-reclutamiento-info" style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #ccc;">
             L√≠mite turno: <span id="limite-reclutar-actual">0</span> / <span id="limite-reclutar-maximo">0</span>
        </div>
        <div class="botones-modal">
             <button id="btn-confirmar-reclutar" class="btn-confirmar">‚úîÔ∏è Reclutar</button>
             <button class="btn-cancelar" onclick="cerrarModal('modal-reclutar')">‚úñÔ∏è Cancelar</button>
        </div>
    </div>
    <!-- Fin Modal Reclutar -->

     <!-- Modal Construir (Sin cambios estructurales) -->
    <div id="modal-construir" class="modal-juego" style="display: none;">
        <button class="modal-cerrar" onclick="cerrarModal('modal-construir')">X</button>
        <h2>Construir Edificio</h2>
        <div class="campo-formulario">
            <label for="select-territorio-construir">Construir en:</label>
            <select id="select-territorio-construir"><option value="">-- Selecciona territorio --</option></select>
        </div>
        <div class="campo-formulario">
            <label for="select-edificio-construir">Tipo de Edificio:</label>
            <select id="select-edificio-construir">
                <option value="">-- Selecciona --</option>
                <optgroup label="Producci√≥n">
                    <option value="Granja">Granja</option>
                    <option value="icamente en el tablero, entonces los botones "Mover" y "Reorganizar" en la app solo necesitan servir como un registro de que esa acci√≥n se ha consumido en el turno del jugador.

Aqu√≠ est√°n las modificaciones para simplificarlo de esa manera:

**1. Modificar `juego.html`**

*   **Elimina COMPLETAMENTE** el modal `#modal-mover` que a√±adimos en el paso anterior. Ya no es necesario.
*   Los botones `#btn-mover` y `#btn-reorganizar` en `#acciones-container` se mantienen, pero su funci√≥n cambiar√° en el JavaScript.

**2. Modificar `scriptjuego.js`**

*   **Elimina** las funciones que a√±adimos para el modal de movimiento:
    *   `poblarTerritoriosOrigenMover`
    *   `poblarTropasDisponiblesMover`
    *   `poblarTerritoriosDestinoMover`
    *   `confirmarMover` (si la creamos)
*   **Modifica** la secci√≥n de inicializaci√≥n de listeners `DOMContentLoaded` para cambiar lo que hacen los botones `#btn-mover` y `#btn-reorganizar`.
*   **Crea** una funci√≥n helper para manejar el fin de acci√≥n.

```javascript
// --- EN scriptjuego.js ---

// ... (c√≥digo anterior: conexi√≥n, par√°metros, gameState, constantes, funciones UI, etc.) ...

// --- L√≥gica Juego y Modales Espec√≠ficos ---

// *** FUNCI√ìN NUEVA: Helper para terminar acci√≥n por botones espec√≠ficos ***
function terminarAccionEspecifica(tipoAccion) {
    const botonAccionEl = document.getElementById('boton-accion');
    const estadoTurnoEl = document.getElementById('estado-turno');
    if (!partida || !nombre) return console.error("Faltan datos para terminar acci√≥n.");
    if (gameState?.fase === 'Neutral') return; // No hacer nada si ya est√° procesando

    console.log(`[${nombre}] Acci√≥n '${tipoAccion}' realizada en el tablero. Emitiendo 'accion-terminada'...`);
    socket.emit('accion-terminada', { partida, nombre });

    // Deshabilitar bot√≥n principal y mostrar espera INMEDIATAMENTE
    // (Aunque se us√≥ un bot√≥n espec√≠fico, deshabilitamos el principal para indicar que la acci√≥n del turno se gast√≥)
    if (botonAccionEl) {
        botonAccionEl.disabled = true;
        botonAccionEl.textContent = "‚åõ Esperando...";
    }
    if (estadoTurnoEl) estadoTurnoEl.textContent = "‚åõ Esperando otros jugadores...";

    // Opcional: Deshabilitar TODOS los botones de acci√≥n hasta el siguiente turno/acci√≥n
    deshabilitarBotonesAccion(true);
}

// *** FUNCI√ìN NUEVA: Helper para habilitar/deshabilitar botones de acci√≥n ***
function deshabilitarBotonesAccion(deshabilitar) {
     const container = document.getElementById('acciones-container');
     if(container) {
         const botones = container.querySelectorAll('.btn-accion-juego');
         botones.forEach(btn => btn.disabled = deshabilitar);
     }
     // Habilitar/Deshabilitar tambi√©n el bot√≥n principal
     const botonPrincipal = document.getElementById('boton-accion');
     if(botonPrincipal) {
        botonPrincipal.disabled = deshabilitar || gameState?.fase === 'Neutral'; // Asegurar deshabilitado en Neutral
     }
}


// La funci√≥n siguienteAccion (para el bot√≥n principal) se mantiene igual:
function siguienteAccion() {
    const botonAccionEl = document.getElementById('boton-accion');
    const estadoTurnoEl = document.getElementById('estado-turno');
    if (!partida || !nombre) return console.error("Faltan datos para terminar acci√≥n.");
    if (gameState?.fase === 'Neutral') return;

    console.log(`[${nombre}] Bot√≥n 'Terminar Acci√≥n' presionado. Emitiendo 'accion-terminada'...`);
    socket.emit('accion-terminada', { partida, nombre });

    if (botonAccionEl) {
        botonAccionEl.disabled = true;
        botonAccionEl.textContent = "‚åõ Esperando...";
    }
    if (estadoTurnoEl) estadoTurnoEl.textContent = "‚åõ Esperando otros jugadores...";
    deshabilitarBotonesAccion(true); // Deshabilitar otros botones tambi√©n
}


// ... (c√≥digo anterior para Modal Batalla, Reclutar, Construir, Mis Territorios) ...


// --- Listeners de Socket.IO ---

// ... (listeners anteriores: connect, disconnect, error, error-accion) ...

socket.on('avanzar-accion', (nuevoEstado) => {
    console.log(`[${nombre}] Recibido 'avanzar-accion'`, nuevoEstado);
    if (gameState && nuevoEstado) {
        gameState.turno = nuevoEstado.turno;
        gameState.accion = nuevoEstado.accion;
        gameState.fase = nuevoEstado.fase;
        gameState.jugadoresAccionTerminada = [];
    }
    actualizarTurnoAccionUI();
    // Reactivar TODOS los botones para la nueva acci√≥n (si no es fase neutral)
    deshabilitarBotonesAccion(gameState?.fase === 'Neutral');
    if(gameState?.fase !== 'Neutral'){
        const botonAccionEl = document.getElementById('boton-accion');
         if(botonAccionEl) botonAccionEl.textContent = "‚úÖ Terminar Acci√≥n"; // Resetear texto
    }

    console.log(`[${nombre}] Avanzado localmente a T${gameState?.turno}, A${gameState?.accion}, F:${gameState?.fase}`);
});

// ... (listeners anteriores: estado-espera-jugadores, actualizar-estado-juego) ...


// --- Inicializaci√≥n DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', () => {
    // ... (c√≥digo inicial igual que antes: validaci√≥n datos, UI inicial, etc.) ...

    console.log("[Init] A√±adiendo listeners...");
    let listenersOk = true;
    try {
        const setupListener = (id, event, handler) => {
            const element = document.getElementById(id);
            if (element) { element.addEventListener(event, handler); }
            else { console.warn(`WARN: Elemento #${id} no encontrado.`); listenersOk = false; }
        };

        // Botones barra superior y principal
        setupListener('logo-casa-container', 'click', abrirModalMisTerritorios);
        setupListener('boton-accion', 'click', siguienteAccion); // El bot√≥n principal sigue funcionando igual

        // Botones de Acci√≥n
        setupListener('btn-batalla', 'click', () => { poblarTerritoriosAtacables(); abrirModal('modal-batalla'); });
        setupListener('btn-reclutar', 'click', () => { poblarTerritoriosReclutar(); poblarUnidadesReclutar(); abrirModal('modal-reclutar'); });
        setupListener('btn-construir', 'click', () => { poblarTerritoriosConstruir(); poblarEdificiosConstruir(); abrirModal('modal-construir'); });
        // *** Listener MODIFICADO para Mover ***
        setupListener('btn-mover', 'click', () => terminarAccionEspecifica('Mover'));
        // *** Listener MODIFICADO para Reorganizar ***
        setupListener('btn-reorganizar', 'click', () => terminarAccionEspecifica('Reorganizar'));

        // ... (listeners para los modales Batalla, Reclutar, Construir, Mis Territorios igual que antes) ...

        if (!listenersOk) console.error("¬°¬° ALGUNCantera">Cantera</option>
                    <option value="Mina">Mina</option>
                    <option value="Aserradero">Aserradero</option>
                </optgroup>
                 <optgroup label="Militar">
                    <option value="Castillo">Castillo</option>
                    <option value="Puerto">Puerto</option>
                    <option value="Taller de maquinaria de asedio">Taller de Asedio</option>
                 </optgroup>
            </select>
        </div>
         <div id="costo-construccion" style="text-align: center; margin-top: 15px; font-weight: bold;">
            Costo: <span id="costo-construir-valor">--</span> <img src="../imgs/Interfaz/oro.png" alt="oro" class="icono-inline">
        </div>
         <div id="limite-construccion-info" style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #ccc;">
             (<span id="limite-construir-actual">0</span> / <span id="limite-construir-maximo">1</span> edificios este turno)
        </div>
        <div class="botones-modal">
             <button id="btn-confirmar-construir" class="btn-confirmar">‚úîÔ∏è Construir</button>
             <button class="btn-cancelar" onclick="cerrarModal('modal-construir')">‚úñÔ∏è Cancelar</button>
        </div>
    </div>
    <!-- Fin Modal Construir -->

    <!-- ****** ELIMINADO Modal Mover/Atacar ****** -->

    <!-- Modal Mis Territorios (Sin cambios estructurales) -->
    <div id="modal-mis-territorios" class="modal-juego" style="display: none;">
        <button id="btn-cerrar-modal-territorios" class="modal-cerrar">X</button>
        <h2>Mis Territorios (<span id="contador-territorios">0</span>)</h2>
        <p>Ingresos por turno: <span id="oro-generado-territorios">0</span> <img src="../imgs/Interfaz/oro.png" alt="oro" class="icono-inline"></p>
        <div class="lista-scrollable">
            <ul id="lista-mis-territorios"><li>Cargando...</li></ul>
        </div>
         <div class="botones-modal">
             <button id="btn-ok-modal-territorios" class="btn-confirmar">OK</button>
        </div>
    </div>
    <!-- Fin Modal Mis Territorios -->

    <!-- Info Adicional (Sin cambios) -->
    <div id="info-adicional" style="position: fixed; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; max-width: 250px; z-index: 5;">
        <h4>Rumores Desbloqueados:</h4>
        <ul id="lista-rumores" style="list-style: none; padding: 0; margin: 0; font-size: 0.9em;">
            <li>(Ninguno)</li>
        </ul>
    </div>

  <script src="../javascript/scriptjuego.js"></script>
</body>
</html>